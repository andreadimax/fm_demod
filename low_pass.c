#include <stdio.h>
#include <stdlib.h>

#include "low_pass.h"

#include <string.h>

#define ORDER 311
#define ORDER2 149

/*  LOW PASS FILTER IMPLEMENTING
    HAMMING WINDOW COEFFICIENTS
    
    FIR FORMULA: y(n) = sum[k: 0 - N-1]{ h(k)*x(n-k)}
    N -> Number of filter coefficients (ORDER of the filter)
    h() -> array of filter coefficient
    x() -> array of inputs

*/

double coeffs1[311]= {
    0.000042470256607263,
    0.000082676531095603,
    0.000118102892733567,
    0.000146452908465286,
    0.000165772726499559,
    0.000174564541113109,
    0.000171885706495690,
    0.000157428247104197,
    0.000131573141722009,
    0.000095413709548814,
    0.000050742859182431,
    0.000000000000000000,
    -0.000053824872181049,
    -0.000107330023625282,
    -0.000156880917378904,
    -0.000198823028714970,
    -0.000229718830697925,
    -0.000246595899450124,
    -0.000247190261886361,
    -0.000230167144947113,
    -0.000195300501914266,
    -0.000143593336781312,
    -0.000077323069169589,
    0.000000000000000002,
    0.000083767771436801,
    0.000168503136558274,
    0.000248175347165942,
    0.000316587291861127,
    0.000367812798428545,
    0.000396655857108204,
    0.000399099040694790,
    0.000372705931897674,
    0.000316942475611200,
    0.000233385096368377,
    0.000125789189070866,
    -0.000000000000000001,
    -0.000136301475607759,
    -0.000274012803718878,
    -0.000403167006923350,
    -0.000513601848823225,
    -0.000595700038198877,
    -0.000641149917687058,
    -0.000643670442467700,
    -0.000599642415077011,
    -0.000508590477353321,
    -0.000373467409898088,
    -0.000200703645356036,
    0.000000000000000001,
    0.000216140432162369,
    0.000433125686193045,
    0.000635198255166267,
    0.000806514390753852,
    0.000932309649859956,
    0.001000069395821505,
    0.001000616787094919,
    0.000929030843533531,
    0.000785313887000415,
    0.000574740940746930,
    0.000307842962122482,
    -0.000000000000000001,
    -0.000329352008842080,
    -0.000657867937057234,
    -0.000961732215826066,
    -0.001217302391843918,
    -0.001402849336846958,
    -0.001500271808762225,
    -0.001496657160895394,
    -0.001385563279424698,
    -0.001167909608437200,
    -0.000852387010157263,
    -0.000455326115988708,
    0.000000000000000002,
    0.000484622868006993,
    0.000965618101043595,
    0.001408240465185145,
    0.001778322951973894,
    0.002044781147891160,
    0.002182047138830153,
    0.002172252004461012,
    0.002006983688768308,
    0.001688467827493177,
    0.001230052170534691,
    0.000655918818575098,
    -0.000000000000000002,
    -0.000695870764676237,
    -0.001384483346871168,
    -0.002016309139629163,
    -0.002542903914682922,
    -0.002920431419524454,
    -0.003113062619794313,
    -0.003096000800463483,
    -0.002857895651218222,
    -0.002402439963576866,
    -0.001748989387916025,
    -0.000932106339531551,
    0.000000000000000002,
    0.000988089071487280,
    0.001965434049899718,
    0.002862098691381046,
    0.003609685771021613,
    0.004146249845690260,
    0.004421039035827675,
    0.004398724459488725,
    0.004062793369783008,
    0.003417822875406200,
    0.002490413665384296,
    0.001328644133277673,
    -0.000000000000000003,
    -0.001412162892676980,
    -0.002813461167029365,
    -0.004104372477504488,
    -0.005186825507523932,
    -0.005971080847189860,
    -0.006382450730600530,
    -0.006367392578548787,
    -0.005898528865703996,
    -0.004978194206645069,
    -0.003640187869158795,
    -0.001949512301363813,
    0.000000000000000003,
    0.002090135063573583,
    0.004184647506270389,
    0.006137205421390241,
    0.007800504624281228,
    0.009036030188638262,
    0.009723875963096569,
    0.009772000366058901,
    0.009124302643960781,
    0.007766949013793159,
    0.005732461263587501,
    0.003101197540659588,
    -0.000000000000000003,
    -0.003402051469680591,
    -0.006900665756298454,
    -0.010265859786945081,
    -0.013253520784092469,
    -0.015618421434002681,
    -0.017127988841550982,
    -0.017576057988429091,
    -0.016795814510660232,
    -0.014671152708398758,
    -0.011145742683356137,
    -0.006229212350049716,
    0.000000000000000003,
    0.007395387130260312,
    0.015746773452656054,
    0.024788232556003206,
    0.034209176323297896,
    0.043668083647399311,
    0.052808177954061994,
    0.061274241605224995,
    0.068729679433671434,
    0.074872918138455077,
    0.079452255040750611,
    0.082278347614885700,
    0.083233660033244186,
    0.082278347614885700,
    0.079452255040750611,
    0.074872918138455077,
    0.068729679433671434,
    0.061274241605224995,
    0.052808177954061994,
    0.043668083647399318,
    0.034209176323297896,
    0.024788232556003209,
    0.015746773452656054,
    0.007395387130260312,
    0.000000000000000003,
    -0.006229212350049715,
    -0.011145742683356137,
    -0.014671152708398761,
    -0.016795814510660232,
    -0.017576057988429091,
    -0.017127988841550982,
    -0.015618421434002681,
    -0.013253520784092473,
    -0.010265859786945082,
    -0.006900665756298454,
    -0.003402051469680591,
    -0.000000000000000003,
    0.003101197540659589,
    0.005732461263587501,
    0.007766949013793159,
    0.009124302643960781,
    0.009772000366058901,
    0.009723875963096573,
    0.009036030188638263,
    0.007800504624281228,
    0.006137205421390241,
    0.004184647506270389,
    0.002090135063573583,
    0.000000000000000003,
    -0.001949512301363813,
    -0.003640187869158797,
    -0.004978194206645070,
    -0.005898528865703996,
    -0.006367392578548788,
    -0.006382450730600531,
    -0.005971080847189861,
    -0.005186825507523932,
    -0.004104372477504487,
    -0.002813461167029364,
    -0.001412162892676980,
    -0.000000000000000003,
    0.001328644133277673,
    0.002490413665384297,
    0.003417822875406201,
    0.004062793369783009,
    0.004398724459488725,
    0.004421039035827674,
    0.004146249845690259,
    0.003609685771021613,
    0.002862098691381046,
    0.001965434049899719,
    0.000988089071487280,
    0.000000000000000002,
    -0.000932106339531551,
    -0.001748989387916026,
    -0.002402439963576866,
    -0.002857895651218222,
    -0.003096000800463483,
    -0.003113062619794313,
    -0.002920431419524454,
    -0.002542903914682923,
    -0.002016309139629163,
    -0.001384483346871168,
    -0.000695870764676237,
    -0.000000000000000002,
    0.000655918818575098,
    0.001230052170534692,
    0.001688467827493178,
    0.002006983688768308,
    0.002172252004461012,
    0.002182047138830153,
    0.002044781147891161,
    0.001778322951973895,
    0.001408240465185145,
    0.000965618101043596,
    0.000484622868006994,
    0.000000000000000002,
    -0.000455326115988709,
    -0.000852387010157263,
    -0.001167909608437199,
    -0.001385563279424698,
    -0.001496657160895395,
    -0.001500271808762225,
    -0.001402849336846959,
    -0.001217302391843918,
    -0.000961732215826067,
    -0.000657867937057234,
    -0.000329352008842081,
    -0.000000000000000001,
    0.000307842962122482,
    0.000574740940746930,
    0.000785313887000414,
    0.000929030843533531,
    0.001000616787094919,
    0.001000069395821506,
    0.000932309649859956,
    0.000806514390753852,
    0.000635198255166267,
    0.000433125686193046,
    0.000216140432162369,
    0.000000000000000001,
    -0.000200703645356036,
    -0.000373467409898088,
    -0.000508590477353322,
    -0.000599642415077011,
    -0.000643670442467701,
    -0.000641149917687058,
    -0.000595700038198877,
    -0.000513601848823226,
    -0.000403167006923350,
    -0.000274012803718878,
    -0.000136301475607759,
    -0.000000000000000001,
    0.000125789189070866,
    0.000233385096368377,
    0.000316942475611201,
    0.000372705931897674,
    0.000399099040694791,
    0.000396655857108204,
    0.000367812798428546,
    0.000316587291861127,
    0.000248175347165942,
    0.000168503136558273,
    0.000083767771436801,
    0.000000000000000002,
    -0.000077323069169589,
    -0.000143593336781312,
    -0.000195300501914266,
    -0.000230167144947113,
    -0.000247190261886361,
    -0.000246595899450124,
    -0.000229718830697925,
    -0.000198823028714970,
    -0.000156880917378904,
    -0.000107330023625282,
    -0.000053824872181049,
    0.000000000000000000,
    0.000050742859182431,
    0.000095413709548814,
    0.000131573141722009,
    0.000157428247104197,
    0.000171885706495690,
    0.000174564541113109,
    0.000165772726499559,
    0.000146452908465286,
    0.000118102892733567,
    0.000082676531095603,
    0.000042470256607263
};

double coeffs2[149] = {
    -0.000267713352317557,
    -0.000345133143515914,
    -0.000343698190638883,
    -0.000258655864918819,
    -0.000102049034622847,
    0.000097375865899384,
    0.000297382715899873,
    0.000449044677172301,
    0.000506782833103711,
    0.000440147058739479,
    0.000244700503812493,
    -0.000051292783227837,
    -0.000387440236579546,
    -0.000680783505647070,
    -0.000843805502117320,
    -0.000807637563645937,
    -0.000544889401970282,
    -0.000085393125235180,
    0.000481159809138930,
    0.001019048221992972,
    0.001375980389353839,
    0.001422610808212175,
    0.001092604509696222,
    0.000411914212330298,
    -0.000492882156071862,
    -0.001413010192972440,
    -0.002101823498691957,
    -0.002336667730296302,
    -0.001983695232040639,
    -0.001048028358148142,
    0.000306809849631023,
    0.001780028139372091,
    0.002995230832415800,
    0.003591388824924284,
    0.003322315413646239,
    0.002138740502079996,
    0.000228416419312027,
    -0.002002099036486237,
    -0.004006657523072435,
    -0.005226323651516845,
    -0.005235932509701955,
    -0.003873875292266322,
    -0.001318614510481340,
    0.001914844328654476,
    0.005067370355668809,
    0.007303557418467267,
    0.007920251469800620,
    0.006546378035150167,
    0.003281255674201798,
    -0.001271607947326389,
    -0.006096330183253947,
    -0.009973518855533513,
    -0.011766983434559243,
    -0.010725075135948420,
    -0.006722727444088218,
    -0.000376798867438697,
    0.007008896048559386,
    0.013675681299336892,
    0.017784013934442587,
    0.017856554084617875,
    0.013193697690567085,
    0.004161755322655876,
    -0.007726281160998784,
    -0.019977592549012799,
    -0.029522036949524377,
    -0.033284943509352495,
    -0.028822281064069366,
    -0.014888813443814573,
    0.008184570193967589,
    0.038395389157888350,
    0.072292992897540542,
    0.105493559683746144,
    0.133398297481387623,
    0.151981956292663867,
    0.158500777970109252,
    0.151981956292663867,
    0.133398297481387623,
    0.105493559683746144,
    0.072292992897540542,
    0.038395389157888350,
    0.008184570193967589,
    -0.014888813443814574,
    -0.028822281064069366,
    -0.033284943509352495,
    -0.029522036949524377,
    -0.019977592549012799,
    -0.007726281160998784,
    0.004161755322655876,
    0.013193697690567087,
    0.017856554084617879,
    0.017784013934442587,
    0.013675681299336896,
    0.007008896048559389,
    -0.000376798867438697,
    -0.006722727444088218,
    -0.010725075135948420,
    -0.011766983434559243,
    -0.009973518855533518,
    -0.006096330183253950,
    -0.001271607947326389,
    0.003281255674201798,
    0.006546378035150169,
    0.007920251469800623,
    0.007303557418467267,
    0.005067370355668809,
    0.001914844328654476,
    -0.001318614510481340,
    -0.003873875292266325,
    -0.005235932509701956,
    -0.005226323651516846,
    -0.004006657523072437,
    -0.002002099036486237,
    0.000228416419312027,
    0.002138740502079996,
    0.003322315413646241,
    0.003591388824924283,
    0.002995230832415800,
    0.001780028139372092,
    0.000306809849631024,
    -0.001048028358148142,
    -0.001983695232040640,
    -0.002336667730296303,
    -0.002101823498691957,
    -0.001413010192972440,
    -0.000492882156071863,
    0.000411914212330299,
    0.001092604509696221,
    0.001422610808212176,
    0.001375980389353841,
    0.001019048221992972,
    0.000481159809138930,
    -0.000085393125235180,
    -0.000544889401970282,
    -0.000807637563645937,
    -0.000843805502117322,
    -0.000680783505647070,
    -0.000387440236579546,
    -0.000051292783227837,
    0.000244700503812493,
    0.000440147058739479,
    0.000506782833103711,
    0.000449044677172302,
    0.000297382715899873,
    0.000097375865899384,
    -0.000102049034622848,
    -0.000258655864918819,
    -0.000343698190638884,
    -0.000345133143515914,
    -0.000267713352317557,
};

int low_pass( double *input, int length)
{
    const int totalLenght = (length + (ORDER-1));
    double *buffer = malloc(totalLenght * sizeof(double));

    if(buffer == NULL){
        printf("Error in allocating input buffer\n");
        return -1;
    }

    //Erasing buffer
    for(int i = 0; i< totalLenght; i++){
        buffer[i] = 0;
    }
    
    //Copy input array from position ORDER (previous cells needed for x(n-k))
    memmove(&buffer[ORDER-1], input, length * sizeof(double));

    // double coeffp[ORDER] = {0.0003, 0.0001, -0.0000, -0.0002, -0.0003, -0.0005, -0.0007, -0.0009, -0.0010, -0.0011, -0.0012, -0.0011, -0.0009, -0.0005, 0.0000, 0.0006, 0.0014,
    //                         0.0022, 0.0030, 0.0037, 0.0042, 0.0045, 0.0045, 0.0040, 0.0031, 0.0018, -0.0000, -0.0021, -0.0045, -0.0070, -0.0094, -0.0115, -0.0130, -0.0138,
    //                         -0.0136, -0.0122, -0.0095, -0.0054, 0.0000, 0.0067, 0.0145, 0.0233, 0.0326, 0.0421, 0.0514, 0.0602, 0.0681, 0.0746, 0.0794, 0.0825, 0.0835,
    //                         0.0825, 0.0794, 0.0746, 0.0681, 0.0602, 0.0514, 0.0421, 0.0326, 0.0233, 0.0145, 0.0067, 0.0000, -0.0054, -0.0095, -0.0122, -0.0136, -0.0138,
    //                         -0.0130, -0.0115, -0.0094, -0.0070, -0.0045, -0.0021, -0.0000, 0.0018, 0.0031, 0.0040, 0.0045, 0.0045, 0.0042, 0.0037, 0.0030, 0.0022, 0.0014,
    //                         0.0006, 0.0000, -0.0005, -0.0009, -0.0011, -0.0012, -0.0011, -0.0010, -0.0009, -0.0007, -0.0005, -0.0003, -0.0002, -0.0000, 0.0001}; //0.0003

    double acc;     // accumulator for MACs
    int n;
    int k;

    
 
    // apply the filter to each input sample
    for ( n = 0; n < length; n++ ) {
        double *buffer_init = &buffer[(ORDER-1)+n];
        acc = 0;
        for ( k = 0; k < ORDER; k++ ) {
            acc += coeffs1[k] * (*buffer_init--);
        }
        input[n] = acc;
    }

    free(buffer);

    return 1;
 
}


int low_pass2( double *input, int length)
{
    const int totalLenght = (length + (ORDER2-1));
    double *buffer = malloc(totalLenght * sizeof(double));

    if(buffer == NULL){
        printf("Error in allocating input buffer\n");
        return -1;
    }

    //Erasing buffer
    for(int i = 0; i< totalLenght; i++){
        buffer[i] = 0;
    }
    
    //Copy input array from position ORDER (previous cells needed for x(n-k))
    memmove(&buffer[ORDER2-1], input, length * sizeof(double));

    double acc;     // accumulator for MACs
    int n;
    int k;

    
 
    // apply the filter to each input sample
    for ( n = 0; n < length; n++ ) {
        double *buffer_init = &buffer[(ORDER2-1)+n];
        acc = 0;
        for ( k = 0; k < ORDER; k++ ) {
            acc += coeffs2[k] * (*buffer_init--);
        }
        input[n] = acc;
    }

    free(buffer);

    return 1;
 
}