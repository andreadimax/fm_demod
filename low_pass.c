#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <complex.h>

#include "low_pass.h"

#include <string.h>

#define ORDER 311
#define ORDER2 311
#define PI 3.141592653589793

/*  LOW PASS FILTER IMPLEMENTING
    HAMMING WINDOW COEFFICIENTS
    
    FIR FORMULA: y(n) = sum[k: 0 - N-1]{ h(k)*x(n-k)}
    N -> Number of filter coefficients (ORDER of the filter)
    h() -> array of filter coefficient
    x() -> array of inputs

*/

double coeffs1[311]= {
    0.000130360917280920,
    0.000042854908411932,
    -0.000064004025875706,
    -0.000146652712307805,
    -0.000170384454111737,
    -0.000123604172629770,
    -0.000023258716912308,
    0.000091015242608883,
    0.000172143126857521,
    0.000184576604907099,
    0.000119513765663258,
    -0.000000000000000002,
    -0.000126772776787630,
    -0.000207628562593700,
    -0.000205254441054084,
    -0.000114947136410335,
    0.000031084406967621,
    0.000174607522988744,
    0.000254066991130517,
    0.000230481159058982,
    0.000105840069525293,
    -0.000074430787247363,
    -0.000237340365450016,
    -0.000311330169069061,
    -0.000257122146071804,
    -0.000087342639908027,
    0.000134494769552811,
    0.000317019207881571,
    0.000378045195967292,
    0.000280860698994101,
    0.000054004092584198,
    -0.000215475440001469,
    -0.000414670259230796,
    -0.000451480494022220,
    -0.000296269069339151,
    0.000000000000000000,
    0.000321028473322235,
    0.000530074276020368,
    0.000527481736084161,
    0.000296932715283792,
    -0.000080607159464219,
    -0.000453979969826778,
    -0.000661577083779287,
    -0.000600460499606202,
    -0.000275622699150088,
    0.000193584702138953,
    0.000616052583627747,
    0.000805941637107946,
    0.000663435242662566,
    0.000224508229441731,
    -0.000344235815219037,
    -0.000807614708091409,
    -0.000958246112667490,
    -0.000708120615187120,
    -0.000135398475319578,
    0.000537107978845598,
    0.001027461883964969,
    0.001111829023793561,
    0.000725057125849291,
    -0.000000000000000003,
    -0.000775717006090623,
    -0.001272637138556467,
    -0.001258278009213309,
    -0.000703768698184885,
    0.000189826578728114,
    0.001062299677009834,
    0.001538293534384638,
    0.001387453585804990,
    0.000632930447923348,
    -0.000441829945786786,
    -0.001397607052181003,
    -0.001817597595498222,
    -0.001487532373371582,
    -0.000500522636022018,
    0.000763174017898630,
    0.001780749095385919,
    0.002101666100438626,
    0.001545045342624884,
    0.000293938312056334,
    -0.001160313417098636,
    -0.002209099270709137,
    -0.002379520244726957,
    -0.001544874081601712,
    0.000000000000000014,
    0.001638972199071881,
    0.002678265386853651,
    0.002638028973576599,
    0.001470149232956656,
    -0.000395178220652292,
    -0.002204270850258303,
    -0.003182130242141346,
    -0.002861794641949228,
    -0.001301964973376992,
    0.000906578675221762,
    0.002861066711895385,
    0.003712962694942401,
    0.003032903683758448,
    0.001018771531436744,
    -0.001551069871889024,
    -0.003614610419462513,
    -0.004261596774609902,
    -0.003130411644328859,
    -0.000595213465181637,
    0.002348854992813466,
    0.004471693151940342,
    0.004817673490995626,
    0.003129332208567849,
    -0.000000000000000006,
    -0.003326042476774208,
    -0.005442604765120940,
    -0.005369937228970044,
    -0.002998700618350798,
    0.000807976892998806,
    0.004519231321984185,
    0.006544530765222402,
    0.005906576153702124,
    0.002697854924986443,
    -0.001886870622990166,
    -0.005983957530710216,
    -0.007807712679718403,
    -0.006415594015550933,
    -0.002169088170983690,
    0.003325963026844144,
    0.007811146753644567,
    0.009287408752563437,
    0.006885199224934762,
    0.001322298373814083,
    -0.005275105542065265,
    -0.010161852729808570,
    -0.011089373244136570,
    -0.007304196139546197,
    0.000000000000000008,
    0.008012792118393420,
    0.013349249944470605,
    0.013431291375099783,
    0.007662363214828044,
    -0.002113406926943640,
    -0.012127840373951405,
    -0.018065016538186082,
    -0.016818728827027517,
    -0.007950803031498527,
    0.005777332158818571,
    0.019120342111407302,
    0.026171051026651078,
    0.022699873439977845,
    0.008162250219674608,
    -0.013433597105081971,
    -0.034255847467971390,
    -0.044882911390056728,
    -0.037391964613639278,
    -0.008291324907507884,
    0.039735235341508392,
    0.097959644929150436,
    0.153699374617983359,
    0.193788748100536867,
    0.208368036645622562,
    0.193788748100536867,
    0.153699374617983359,
    0.097959644929150436,
    0.039735235341508392,
    -0.008291324907507884,
    -0.037391964613639278,
    -0.044882911390056734,
    -0.034255847467971390,
    -0.013433597105081971,
    0.008162250219674608,
    0.022699873439977845,
    0.026171051026651078,
    0.019120342111407299,
    0.005777332158818571,
    -0.007950803031498529,
    -0.016818728827027517,
    -0.018065016538186082,
    -0.012127840373951405,
    -0.002113406926943640,
    0.007662363214828044,
    0.013431291375099784,
    0.013349249944470605,
    0.008012792118393420,
    0.000000000000000008,
    -0.007304196139546199,
    -0.011089373244136570,
    -0.010161852729808570,
    -0.005275105542065266,
    0.001322298373814083,
    0.006885199224934763,
    0.009287408752563439,
    0.007811146753644567,
    0.003325963026844144,
    -0.002169088170983690,
    -0.006415594015550933,
    -0.007807712679718403,
    -0.005983957530710218,
    -0.001886870622990166,
    0.002697854924986443,
    0.005906576153702124,
    0.006544530765222403,
    0.004519231321984185,
    0.000807976892998806,
    -0.002998700618350798,
    -0.005369937228970043,
    -0.005442604765120939,
    -0.003326042476774208,
    -0.000000000000000006,
    0.003129332208567849,
    0.004817673490995627,
    0.004471693151940343,
    0.002348854992813467,
    -0.000595213465181637,
    -0.003130411644328859,
    -0.004261596774609901,
    -0.003614610419462513,
    -0.001551069871889024,
    0.001018771531436744,
    0.003032903683758448,
    0.003712962694942401,
    0.002861066711895385,
    0.000906578675221762,
    -0.001301964973376992,
    -0.002861794641949228,
    -0.003182130242141346,
    -0.002204270850258303,
    -0.000395178220652292,
    0.001470149232956657,
    0.002638028973576600,
    0.002678265386853652,
    0.001638972199071881,
    0.000000000000000014,
    -0.001544874081601712,
    -0.002379520244726959,
    -0.002209099270709137,
    -0.001160313417098636,
    0.000293938312056334,
    0.001545045342624884,
    0.002101666100438627,
    0.001780749095385919,
    0.000763174017898630,
    -0.000500522636022018,
    -0.001487532373371583,
    -0.001817597595498222,
    -0.001397607052181004,
    -0.000441829945786786,
    0.000632930447923348,
    0.001387453585804989,
    0.001538293534384639,
    0.001062299677009834,
    0.000189826578728114,
    -0.000703768698184885,
    -0.001258278009213309,
    -0.001272637138556467,
    -0.000775717006090624,
    -0.000000000000000003,
    0.000725057125849291,
    0.001111829023793561,
    0.001027461883964968,
    0.000537107978845599,
    -0.000135398475319579,
    -0.000708120615187120,
    -0.000958246112667491,
    -0.000807614708091410,
    -0.000344235815219037,
    0.000224508229441731,
    0.000663435242662566,
    0.000805941637107946,
    0.000616052583627747,
    0.000193584702138953,
    -0.000275622699150089,
    -0.000600460499606203,
    -0.000661577083779287,
    -0.000453979969826778,
    -0.000080607159464219,
    0.000296932715283792,
    0.000527481736084161,
    0.000530074276020368,
    0.000321028473322235,
    0.000000000000000000,
    -0.000296269069339151,
    -0.000451480494022220,
    -0.000414670259230796,
    -0.000215475440001469,
    0.000054004092584198,
    0.000280860698994101,
    0.000378045195967293,
    0.000317019207881571,
    0.000134494769552811,
    -0.000087342639908027,
    -0.000257122146071804,
    -0.000311330169069062,
    -0.000237340365450016,
    -0.000074430787247363,
    0.000105840069525293,
    0.000230481159058982,
    0.000254066991130518,
    0.000174607522988744,
    0.000031084406967621,
    -0.000114947136410335,
    -0.000205254441054084,
    -0.000207628562593700,
    -0.000126772776787630,
    -0.000000000000000002,
    0.000119513765663258,
    0.000184576604907099,
    0.000172143126857521,
    0.000091015242608883,
    -0.000023258716912308,
    -0.000123604172629770,
    -0.000170384454111737,
    -0.000146652712307805,
    -0.000064004025875706,
    0.000042854908411932,
    0.000130360917280920
};

double coeffs2[ORDER2] = {
    0.000062860365070682,
    0.000117043103270613,
    -0.000154468334054573,
    0.000000000000000000,
    0.000158720576469841,
    -0.000123563333766767,
    -0.000068168577249764,
    0.000181970342280110,
    -0.000071280458940618,
    -0.000135074809164897,
    0.000181318715505619,
    -0.000000000000000001,
    -0.000192331627412526,
    0.000151944437831879,
    0.000084991082856560,
    -0.000229818315670406,
    0.000091104758943699,
    0.000174549832600473,
    -0.000236674522358415,
    0.000000000000000002,
    0.000255436107215217,
    -0.000203281505926186,
    -0.000114446126411084,
    0.000311227305469445,
    -0.000123984951218175,
    -0.000238545688265581,
    0.000324591816024525,
    -0.000000000000000004,
    -0.000352165646498670,
    0.000280767902518334,
    0.000158279675143269,
    -0.000430808493677491,
    0.000171705295044752,
    0.000330397460731376,
    -0.000449480666921490,
    0.000000000000000006,
    0.000487044066434373,
    -0.000387913092846781,
    -0.000218417899786330,
    0.000593669217216149,
    -0.000236250150751584,
    -0.000453829974681786,
    0.000616288009748966,
    -0.000000000000000011,
    -0.000665192206003088,
    0.000528708498598763,
    0.000297062118902749,
    -0.000805675353701743,
    0.000319910157310840,
    0.000613165232581256,
    -0.000830784191639177,
    0.000000000000000017,
    0.000892648194904145,
    -0.000707886651881679,
    -0.000396837085172049,
    0.001073861036353170,
    -0.000425448032517907,
    -0.000813646416827823,
    0.001100010747695876,
    -0.000000000000000027,
    -0.001176868709304323,
    0.000931327232469119,
    0.000521023613367041,
    -0.001407072345508747,
    0.000556359486418549,
    0.001061948692815211,
    -0.001432987756014677,
    -0.000000000000000006,
    0.001527524409995656,
    -0.001206703033307019,
    -0.000673929666635690,
    0.001816997060600222,
    -0.000717291884676557,
    -0.001367001464898510,
    0.001841856313342963,
    0.000000000000000002,
    -0.001957793959242234,
    0.001544534859089098,
    0.000861498792372066,
    -0.002319860098258247,
    0.000914736549382315,
    0.001741354182575124,
    -0.002343785107426004,
    0.000000000000000005,
    0.002486544811268505,
    -0.001959978547683717,
    -0.001092346347878421,
    0.002939326990244714,
    -0.001158221116131526,
    -0.002203542558378091,
    0.002964293597487341,
    -0.000000000000000016,
    -0.003142182974950731,
    0.002476000659877089,
    0.001379613627708354,
    -0.003711735930735181,
    0.001462473851533527,
    0.002782415970113461,
    -0.003743376699119140,
    0.000000000000000033,
    0.003969863919066970,
    -0.003129377355197905,
    -0.001744501007270189,
    0.004696157860561377,
    -0.001851623970881732,
    -0.003525616519723803,
    0.004747624621306080,
    -0.000000000000000057,
    -0.005046060981000730,
    0.003982946811589028,
    0.002223565919539114,
    -0.005995419693180137,
    0.002368085714017506,
    0.004517738166333166,
    -0.006096516851822163,
    -0.000000000000000003,
    0.006511045986276928,
    -0.005153323186742201,
    -0.002885479504085587,
    0.007805133008646352,
    -0.003093615712244190,
    -0.005924101117173760,
    0.008026932069576683,
    -0.000000000000000022,
    -0.008651627748569271,
    0.006882924352639342,
    0.003875501782081568,
    -0.010546725290601211,
    0.004207786505860547,
    0.008115302453764135,
    -0.011081463750002008,
    0.000000000000000068,
    0.012156500688081887,
    -0.009769100421212162,
    -0.005561584890779085,
    0.015319663134542723,
    -0.006194148366082248,
    -0.012123833331138397,
    0.016828353583231200,
    -0.000000000000000024,
    -0.019188594496487573,
    0.015778749962395387,
    0.009219877479147631,
    -0.026162404101997473,
    0.010945936567938838,
    0.022292314481203186,
    -0.032420856919407728,
    0.000000000000000024,
    0.041810396415643124,
    -0.037379610295108709,
    -0.024300902951410790,
    0.079444213610976283,
    -0.040562807099402950,
    -0.112478576067303826,
    0.294004014433241090,
    0.624897575314556142,
    0.294004014433241090,
    -0.112478576067303826,
    -0.040562807099402950,
    0.079444213610976283,
    -0.024300902951410790,
    -0.037379610295108709,
    0.041810396415643124,
    0.000000000000000024,
    -0.032420856919407728,
    0.022292314481203186,
    0.010945936567938838,
    -0.026162404101997477,
    0.009219877479147629,
    0.015778749962395387,
    -0.019188594496487573,
    -0.000000000000000024,
    0.016828353583231200,
    -0.012123833331138398,
    -0.006194148366082248,
    0.015319663134542727,
    -0.005561584890779085,
    -0.009769100421212162,
    0.012156500688081887,
    0.000000000000000068,
    -0.011081463750002012,
    0.008115302453764135,
    0.004207786505860547,
    -0.010546725290601215,
    0.003875501782081568,
    0.006882924352639344,
    -0.008651627748569273,
    -0.000000000000000022,
    0.008026932069576683,
    -0.005924101117173759,
    -0.003093615712244190,
    0.007805133008646352,
    -0.002885479504085588,
    -0.005153323186742202,
    0.006511045986276929,
    -0.000000000000000003,
    -0.006096516851822165,
    0.004517738166333167,
    0.002368085714017506,
    -0.005995419693180136,
    0.002223565919539114,
    0.003982946811589028,
    -0.005046060981000730,
    -0.000000000000000057,
    0.004747624621306080,
    -0.003525616519723803,
    -0.001851623970881732,
    0.004696157860561379,
    -0.001744501007270189,
    -0.003129377355197904,
    0.003969863919066969,
    0.000000000000000033,
    -0.003743376699119140,
    0.002782415970113462,
    0.001462473851533527,
    -0.003711735930735181,
    0.001379613627708355,
    0.002476000659877090,
    -0.003142182974950731,
    -0.000000000000000016,
    0.002964293597487341,
    -0.002203542558378091,
    -0.001158221116131526,
    0.002939326990244715,
    -0.001092346347878421,
    -0.001959978547683718,
    0.002486544811268506,
    0.000000000000000005,
    -0.002343785107426004,
    0.001741354182575126,
    0.000914736549382315,
    -0.002319860098258246,
    0.000861498792372066,
    0.001544534859089098,
    -0.001957793959242236,
    0.000000000000000002,
    0.001841856313342963,
    -0.001367001464898510,
    -0.000717291884676557,
    0.001816997060600222,
    -0.000673929666635691,
    -0.001206703033307019,
    0.001527524409995656,
    -0.000000000000000006,
    -0.001432987756014677,
    0.001061948692815212,
    0.000556359486418550,
    -0.001407072345508747,
    0.000521023613367041,
    0.000931327232469119,
    -0.001176868709304325,
    -0.000000000000000027,
    0.001100010747695876,
    -0.000813646416827823,
    -0.000425448032517907,
    0.001073861036353170,
    -0.000396837085172049,
    -0.000707886651881679,
    0.000892648194904145,
    0.000000000000000017,
    -0.000830784191639177,
    0.000613165232581256,
    0.000319910157310840,
    -0.000805675353701743,
    0.000297062118902748,
    0.000528708498598763,
    -0.000665192206003089,
    -0.000000000000000011,
    0.000616288009748966,
    -0.000453829974681786,
    -0.000236250150751584,
    0.000593669217216150,
    -0.000218417899786330,
    -0.000387913092846780,
    0.000487044066434372,
    0.000000000000000006,
    -0.000449480666921490,
    0.000330397460731376,
    0.000171705295044752,
    -0.000430808493677491,
    0.000158279675143269,
    0.000280767902518334,
    -0.000352165646498671,
    -0.000000000000000004,
    0.000324591816024525,
    -0.000238545688265581,
    -0.000123984951218175,
    0.000311227305469446,
    -0.000114446126411084,
    -0.000203281505926186,
    0.000255436107215217,
    0.000000000000000002,
    -0.000236674522358415,
    0.000174549832600473,
    0.000091104758943699,
    -0.000229818315670406,
    0.000084991082856560,
    0.000151944437831879,
    -0.000192331627412526,
    -0.000000000000000001,
    0.000181318715505619,
    -0.000135074809164897,
    -0.000071280458940618,
    0.000181970342280110,
    -0.000068168577249764,
    -0.000123563333766767,
    0.000158720576469841,
    0.000000000000000000,
    -0.000154468334054573,
    0.000117043103270613,
    0.000062860365070682
};

int low_pass( double *input, double* output, int length)
{
    // const int totalLenght = (length + (ORDER-1));
    // double *buffer = malloc(totalLenght * sizeof(double));

    // if(buffer == NULL){
    //     printf("Error in allocating input buffer\n");
    //     return -1;
    // }
    
    //Copy input array from position ORDER (previous cells needed for x(n-k))
    //memmove(&buffer[ORDER-1], input, length * sizeof(double));

    // double coeffp[ORDER] = {0.0003, 0.0001, -0.0000, -0.0002, -0.0003, -0.0005, -0.0007, -0.0009, -0.0010, -0.0011, -0.0012, -0.0011, -0.0009, -0.0005, 0.0000, 0.0006, 0.0014,
    //                         0.0022, 0.0030, 0.0037, 0.0042, 0.0045, 0.0045, 0.0040, 0.0031, 0.0018, -0.0000, -0.0021, -0.0045, -0.0070, -0.0094, -0.0115, -0.0130, -0.0138,
    //                         -0.0136, -0.0122, -0.0095, -0.0054, 0.0000, 0.0067, 0.0145, 0.0233, 0.0326, 0.0421, 0.0514, 0.0602, 0.0681, 0.0746, 0.0794, 0.0825, 0.0835,
    //                         0.0825, 0.0794, 0.0746, 0.0681, 0.0602, 0.0514, 0.0421, 0.0326, 0.0233, 0.0145, 0.0067, 0.0000, -0.0054, -0.0095, -0.0122, -0.0136, -0.0138,
    //                         -0.0130, -0.0115, -0.0094, -0.0070, -0.0045, -0.0021, -0.0000, 0.0018, 0.0031, 0.0040, 0.0045, 0.0045, 0.0042, 0.0037, 0.0030, 0.0022, 0.0014,
    //                         0.0006, 0.0000, -0.0005, -0.0009, -0.0011, -0.0012, -0.0011, -0.0010, -0.0009, -0.0007, -0.0005, -0.0003, -0.0002, -0.0000, 0.0001}; //0.0003

    double acc;     // accumulator for MACs
    int n;
    int k;

    FILE* rf2 = fopen("rf2.dat", "wb");

    for ( n = 0; n < length; n++ ) {
        input[n] = input[n] * cexp(-2.0 * PI * I * (300000)/(1920000) * (n+1) );
        fwrite(&input[n], 4,1,rf2);
    }
    fclose(rf2);
 
    // apply the filter to each input sample
    for ( n = 0; n < length; n++ ) {
        //double *buffer_init = &buffer[(ORDER-1)+n];
        acc = 0;
        for ( k = 0; k < ORDER; k++ ) {
            if(n-k < 0){
                acc += 0;
            }
            else{
                acc += coeffs1[k] * input[n-k];
            }
        }
        output[n] = acc;
    }

    //free(buffer);

    return 1;
 
}


int low_pass2( double *input, double* output, int length)
{
 
    double acc;     // accumulator for MACs
    int n;
    int k;

    
 
    // apply the filter to each input sample
    for ( n = 0; n < length; n++ ) {
        //double *buffer_init = &buffer[(ORDER-1)+n];
        acc = 0;
        for ( k = 0; k < ORDER2; k++ ) {
            if(n-k < 0){
                acc += 0;
            }
            else{
                acc += coeffs2[k] * input[n-k];
            }
        }
        output[n] = acc;
    }

    return 1;
 
}